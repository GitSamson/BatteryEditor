<html>

<body>
    <canvas id="MyCanvas" width="100%" height="100%" stroke='black'>

    </canvas>
</body>
<script src="./Graphic_Cal.js"></script>
<script src="./Board_event.js"></script>
<script src="./Diagram_event.js"></script>
<script src='./Controller.js'></script>
<script src='./ConnectionNode.js'></script>

<script>
    // Initialization
    var Canvas = document.getElementById('MyCanvas');
    var body = document.querySelector('body');
    var draw = Canvas.getContext('2d');
    var magnetDistance = 100;
    Canvas.height = window.innerHeight;
    Canvas.width = window.innerWidth;
    d = Canvas.getContext('2d');




    //==============================================================

    function Draw_CreateElement(e) {
        this.e = e;
        Board.onCreate = true;
        diagram.push(new content(this.e.pageX, this.e.pageY, 0, 0));
        Canvas.onmousemove = function (j) {
            if (Board.onCreate) {
                var index = diagram.length - 1;
                diagram[index].width = j.pageX - diagram[index].x;
                diagram[index].height = j.pageY - diagram[index].y;
                Board.redraw();
            }
        }
    }

    function Draw_MoveElements(e) {
        Canvas.onmouseup = function () {
            if (Board.onDrag) { // if on onDrag mode, end onDrag
                Board.onDrag = false;
            }
        }
        var last_e = e;
        Board.onDrag = true;
        Canvas.onmousemove = function (mousemove_e) {
            if (Board.onDrag) {
                this.s = last_e;
                this.n = mousemove_e;
                var offset = { x: (this.n.pageX - this.s.pageX), y: (this.n.pageY - this.s.pageY) }
                Board.selectedElements.forEach(function (i) {
                    i.x = i.x + offset.x;
                    i.y = i.y + offset.y;
                    i.left;
                    i.right;

                });
                Board.redraw();
                last_e = mousemove_e;
            }
        }
    }


    function Element_Select(element) {
        element.selected = true;
        if (Board.selectedElements.indexOf(element) == -1) {
            //in case repeated 
            Board.selectedElements.push(element);
        } else {
            return;
        }
    }
    function Element_Unselect(element) {
        element.selected = false;
        var index = Board.selectedElements.indexOf(element);
        if (index != -1) {
            if (onElement.index == 0) {
                Board.selectedElements.shift()
            } else {
                Board.selectedElements.splice(index, index);
            }
        }

    }

    function Draw_SelectionBox(e) {

        mousedown = { x: e.pageX, y: e.pageY };
        selectBox = new content(mousedown.x, mousedown.y, 0, 0);//instance select box content
        selectBox.dashline = true;
        selectBox.draw();
        Canvas.onmousemove = function (e) {
            Board.onSelection = true;
            selectBox.width = e.pageX - mousedown.x;
            selectBox.height = e.pageY - mousedown.y;
            //## forEach find inSelctBox element
            diagram.forEach(function (i) {
                if ((mousedown.x < i.x) && (e.pageX > i.x + i.width) && (mousedown.y < i.y) && (e.pageY > i.y + i.height)) {
                    Element_Select(i);
                } else {
                    Element_Unselect(i);
                }
            })
            Board.redraw();
            selectBox.draw();
        }

        //referesh mouseup EventListener
        Canvas.addEventListener('mouseup', function (e) {
            selectBox = null;
            Canvas.onmousemove = null;
            Board.redraw();
        })
    }

    function Draw_Select(element) {
        Element_Select(element);
        Board.redraw();
    }




    function Connection_onMouseDown(e, node) {
        var TempConnectElement;

        Canvas.onmousemove = function (move_e) {
            var onMagnet = Board.magnetPoint(move_e);
            Board.redraw()
            node.drawPointLine(onMagnet.position);
            TempConnectElement = onMagnet.element;
        }



        Canvas.onmouseup = function (e) {
            Canvas.onmousemove = null;
            console.log(TempConnectElement);

            if (TempConnectElement.element) {
                node.push(TempConnectElement.element)
                Board.redraw();
                return;
            }

        }
    }


    //======================================================================================

    var diagram = [];
    diagram.push(new content(10, 30, 30, 100, 1));
    diagram.push(new content(50, 50, 100, 100, 2));
    diagram.push(new content(200, 300, 50, 50, 3))
    
    diagram[0].node.left.push(diagram[1].node.right)
    console.log(diagram[0].node.left);

    var selectBox = null;
    var Board = new Canv(d, diagram);
    Board.redraw();

    Canvas.onmousedown = function (e) {


        var onElement = Board.isOnElement(e);

        // on no selection status:
        if (!Board.selectedElements.length) {

            if (onElement) {
                // click on element
                Draw_Select(onElement.element);// select element
                Draw_MoveElements(e);
                return;
            } else {
                Draw_SelectionBox(e); // call selection Box

            }
            //click on background nothing happen
        }


        // on selected status:
        if (Board.selectedElements.length) {

            //click on elements control bar:
            var onNode = Board.isOnControl(e);
            if (onNode) {
                Connection_onMouseDown(e, onNode)
                //call element draw_connection function
                return;// end continue other condition 
            }

            //click on background:
            if (!onElement) {
                //click on background:
                Board.resetSelect(); // reset selection 
                Board.redraw();
                return; // end continue other condition 
            } else {
                // click on element:
                if (onElement.element.selected) {
                    Draw_MoveElements(e);
                } else {
                    Board.resetSelect();
                    Draw_Select(onElement.element);
                    Draw_MoveElements(e);
                }
            }
        }


    }


    Canvas.ondblclick = function (onclick_e) {
        var onElement = Board.isOnElement(onclick_e);
        if (!onElement) {
            Draw_CreateElement(onclick_e);
            Board.redraw();
            //double click in element event
        }
    }


    Canvas.oncontextmenu = function (e) {
        var onElement = Board.isOnElement(e)
        if (Board.onCreate) {
            Board.onCreate = false;
        }
        if (onElement != undefined) {
            if (onElement.index == 0) {
                diagram.shift()
            } else {
                diagram.splice(onElement.index, onElement.index);
            }
            Board.redraw();
        }
        return false; // Cancel defalut right click menu
    }
</script>

</html>