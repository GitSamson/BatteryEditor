<html>

<body>
    <canvas id="MyCanvas" width="100%" height="100%" stroke='black'>

    </canvas>
</body>
<script src="./Board_event.js"></script>
<script src="./Diagram_event.js"></script>
<script>
    // Initialization
    var Canvas = document.getElementById('MyCanvas');
    var body = document.querySelector('body');
    var draw = Canvas.getContext('2d');
    Canvas.height = window.innerHeight;
    Canvas.width = window.innerWidth;
    d = Canvas.getContext('2d');




    //==============================================================

    function Draw_CreateElement(e) {
        this.e = e;
        Board.onCreate = true;
        diagram.push(new content(this.e.pageX, this.e.pageY, 0, 0));
        Canvas.onmousemove = function (j) {
            if (Board.onCreate) {
                var index = diagram.length - 1;
                diagram[index].width = j.pageX - diagram[index].x;
                diagram[index].height = j.pageY - diagram[index].y;
                Board.redraw();
            }
        }
    }

    function Draw_MoveElements(e) {
        Canvas.onmouseup = function () {
            if (Board.onDrag) { // if on onDrag mode, end onDrag
                Board.onDrag = false;
            }
        }
        var last_e = e;
        Board.onDrag = true;
        Canvas.onmousemove = function (mousemove_e) {
            if (Board.onDrag) {
                this.s = last_e;
                this.n = mousemove_e;
                var offset = { x: (this.n.pageX - this.s.pageX), y: (this.n.pageY - this.s.pageY) }
                Board.selectedElements.forEach(function (i) {
                    i.x = i.x + offset.x;
                    i.y = i.y + offset.y;
                    i.left;
                    i.right;

                });
                Board.redraw();
                last_e = mousemove_e;
            }
        }
    }


    function Element_Select(element) {
        element.selected = true;
        if (Board.selectedElements.indexOf(element) == -1) {
            Board.selectedElements.push(element);

        } else {
            return;
        }
    }
    function Element_Unselect(element) {
        element.selected = false;
        var index = Board.selectedElements.indexOf(element);
        if (index != -1) {
            if (onElement.index == 0) {
                Board.selectedElements.shift()
            } else {
                Board.selectedElements.splice(index, index);
            }
        }

    }

    function Draw_SelectionBox(e) {
        console.log('drawing selection ');
        
        mousedown = { x: e.pageX, y: e.pageY };
        selectBox = new content(mousedown.x, mousedown.y, 0, 0);//instance select box content
        selectBox.dashline = true;
        selectBox.draw();
        Canvas.onmousemove = function (e) {
            Board.onSelection = true;
            selectBox.width = e.pageX - mousedown.x;
            selectBox.height = e.pageY - mousedown.y;
            //## forEach find inSelctBox element
            diagram.forEach(function (i) {
                if ((mousedown.x < i.x) && (e.pageX > i.x + i.width) && (mousedown.y < i.y) && (e.pageY > i.y + i.height)) {
                    Element_Select(i);
                } else {
                    Element_Unselect(i);
                }
            })
            Board.redraw();
            selectBox.draw();
        }
        //referesh mouseup EventListener
        Canvas.addEventListener('mouseup', function (e) {
            selectBox = null;
            Canvas.onmousemove = null;
            Board.redraw();
        })
    }






    function Connection_onMouseDown(e) {
        var start = Board.isOnControl(e);
        console.log(start);
        if (start) {
            console.log(start.position.left)

            if (start.position.left) {
                Canvas.onmousemove = function (e) {
                    Board.redraw()
                    start.element.Draw_Connection(e,null);
                }
            }
            if (start.position.right) {
                Canvas.onmousemove = function (e) {

                    Board.redraw()
                    start.element.Draw_Connection(null, e);
                }
            }



            Canvas.onmouseup = function (e) {
                Canvas.onmousemove = null;
                var onElement = Board.isOnElement(e);
                if (onElement && start.position.left) {
                    start.element.left_ConnectTo.push(onElement.element);
                    Board.redraw();
                    return;
                }
                if (onElement && start.position.right) {
                    start.element.right_ConnectTo.push(onElement.element);
                    Board.redraw();
                    return;
                }
            }
        }else{
            Board.resetSelect();
            Board.redraw()
        }
    }


    //======================================================================================

    var diagram = [];
    diagram.push(new content(10, 30, 30, 100, 1));
    diagram.push(new content(50, 50, 100, 100, 2));
    diagram.push(new content(200, 300, 50, 50, 3))
    diagram[2].left_ConnectTo.push(diagram[1]);

    var selectBox = null;
    var Board = new Canv(d, diagram);
    Board.redraw();

    Canvas.onmousedown = function (e) {
        
        
        
        var onElement = Board.isOnElement(e);
        if (onElement) { // if click on the block
            console.log('Click onElement');
            if (!onElement.element.selected) { // if block didnt selected
                Board.resetSelect();
                Element_Select(onElement.element);
                Board.redraw();
                Draw_MoveElements(e);
            } else if (onElement.element.selected) { // if block already selected
                Draw_MoveElements(e);
            }
        }
        else {
                        console.log('Didnt Click onElement');

            if (Board.selectedElements==[]) {
                console.log('on Selection',Board.selectedElements);
                
                Connection_onMouseDown(e);
                return;
            }else{
                console.log('draw selection');
                
            Draw_SelectionBox(e);
            Canvas.onmouseup = Board.resetSelect();
            Board.redraw();
        }}
                console.log(Board.selectedElements);

    }
    
    
    Canvas.ondblclick = function (onclick_e) {
        var onElement = Board.isOnElement(onclick_e);
        if (onElement) {
            onElement.element.state_onControl = true;
            Board.redraw();
            //double click in element event
        } else {
            Draw_CreateElement(onclick_e);
        }
    }


    Canvas.oncontextmenu = function (e) {
        var onElement = Board.isOnElement(e)
        if (Board.onCreate) {
            Board.onCreate = false;
        }
        if (onElement != undefined) {
            if (onElement.index == 0) {
                diagram.shift()
            } else {
                diagram.splice(onElement.index, onElement.index);
            }
            Board.redraw();
        }
        return false; // Cancel defalut right click menu
    }
</script>

</html>